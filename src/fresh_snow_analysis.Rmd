---
title: "Fresh Snow Analysis"
author: "Danielle Reimanis"
date: "4/20/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(tidyr)
library(lubridate)
library(ggthemes)
library(ggpubr)
library(ggplot2)
library(stringr)
library(purrr)
library(xts)
library(dygraphs)
library(hms)
library(RNRCS)
library(ggh4x)

setwd("~/Desktop/Albedo Analysis/albedo-research")
```

### Loading 

```{r}

load(file = "data/sasp_sbsp_long.Rdata")

```

### RMP Density

```{r}
#list.files("data/")
load("data/red_mtn_pass.Rdata")

# red_mtn_pass <- grabNRCS.data(network = 'SNTL', site_id  = '713',
#                                timescale = 'daily',
#                                  DayBgn = '2005-09-01', DayEnd = '2014-08-31')
# 
# save(red_mtn_pass, file = "data/red_mtn_pass.Rdata")

RMP_clean <- red_mtn_pass%>%
  select(1:4,6:8)%>%
  rename(date =1, Tavg_F = 2, Tmax_F = 3, Tmin_F = 4, Precip_in = 5, Ds_in = 6, SWE_in = 7)%>%
  mutate(date = ymd(date),
         ds_m = Ds_in/39.3)%>%
  filter(ds_m < 4)%>%
  mutate(swe_mm = SWE_in*25.4,
         density = ifelse(ds_m >0 & swe_mm >0, swe_mm/ds_m, 0))%>%
  filter(density < 500)

ggplot(RMP_clean%>%filter(month(date) < 8), aes(x=date))+
  geom_line(aes(y=ds_m), color = "blue")+
  geom_line(aes(y=density/200), color = "black")+
  facet_wrap(~year(date), scales ="free_x")+
  theme_bw()+
  theme(axis.title.y.left = element_text(colour="blue", 
                                         size = 17.5, 
                                         family = "Times New Roman"),
        axis.text.y.left = element_text(colour="blue"),
        text = element_text(size = 17.5, family = "Times New Roman"))+
  scale_y_continuous(name = "Depth (m)",
                     sec.axis = sec_axis(~.*200, name = "Density (kg/m^3)"))+
  xlab(element_blank())


```

### Density DyGraph
```{r}

RMP_clean_xts <- RMP_clean%>%
  select(1,8:10)%>%
  xts(., order.by = .$date)
  
dygraph(RMP_clean_xts)

RMP_density <- RMP_clean%>%
  select(1, 8:10)%>%
  mutate(dens_diff = density - lag(density),
         dens_diff = ifelse(is.na(dens_diff), 0, dens_diff))%>%
  mutate(density = ifelse(month(date) > 8 & density > 298, 219, density))

RMP_clean_xts2 <- RMP_density%>%
  select(1:4)%>%
  xts(., order.by = .$date)

dygraph(RMP_clean_xts2)

rep_dens_value <- RMP_density%>%
  filter(density < 300)%>%
  filter(month(date) > 8)%>%
  filter(density > 0)%>%
  summarize(mean = mean(density))
rep_dens_value

ggplot(RMP_density, aes(x=date))+
  geom_line(aes(y=ds_m), color = "blue")+
  geom_line(aes(y=density/200), color = "black")+
  facet_wrap(~year(date), scales ="free_x")+
  theme_bw()+
  theme(axis.title.y.left = element_text(colour="blue", 
                                         size = 17.5, 
                                         family = "Times New Roman"),
        axis.text.y.left = element_text(colour="blue"),
        text = element_text(size = 17.5, family = "Times New Roman"))+
  scale_y_continuous(name = "Depth (m)",
                     sec.axis = sec_axis(~.*200, name = "Density (kg/m^3)"))+
  xlab(element_blank())

```

### SBB with RMP Density Improvement

```{r}

sasp_dens <- sasp_sbsp_long%>%
  filter(site == "SASP")%>%
  merge(., RMP_density, by = "date")%>%
  mutate(density = ifelse(depth_m == 0, 0, density),
         swe_mm = ifelse(depth_m == 0, 0, swe_mm))

sbsp_dens <- sasp_sbsp_long%>%
  filter(site == "SBSP")%>%
  merge(., RMP_density, by = "date")%>%
  mutate(density = ifelse(depth_m == 0, 0, density),
         swe_mm = ifelse(depth_m == 0, 0, swe_mm))
  mutate(density = ifelse(DOSY > 250 & swe_mm/100 < depth_m, 250, density),
         swe_mm = ifelse(DOSY > 250 & swe_mm/100 < depth_m, density*depth_m, swe_mm))


ggplot(sbsp_dens%>%filter(DOSY>200 & DOSY <305), aes(x=DOSY))+
  geom_point(aes(y=depth_m))+
  geom_point(aes(y=density/100), color = "blue3")+
  geom_point(aes(y=swe_mm/100), color = "red3")+
  facet_wrap(~SY)


```


### Fresh Snow Density

```{r}

names(sasp_sbsp_long)

fresh_snow <- sasp_sbsp_long%>%
  filter(!SY == "SY2005")%>%
  mutate(HP_dens = ifelse(depth_m - lag(depth_m) > 0 & Tavg_C < 0, 67.92+51.25*exp(Tavg_C/2.59), NA))%>%
  mutate(DL_dens = ifelse(depth_m - lag(depth_m) > 0 & Tavg_C < 0, 119+6.48*Tavg_C, NA))%>%
  mutate(LaCh_dens = ifelse(depth_m - lag(depth_m) > 0 & Tavg_C < 0, 50 + 1.7*(Tavg_C+15)^1.5, NA))%>%
  mutate(PS_dens = ifelse(depth_m - lag(depth_m) > 0 & Tavg_C < 0, 
                               85*((-0.030*cos(0.331*Tavg_C+0.418)+0.015*cos(2*0.331*Tavg_C+0.418)-
                                    0.029*cos(3*0.331*Tavg_C+0.418)+0.123*sin(0.331*Tavg_C+0.418)+
                                      0.009*sin(2*0.331*Tavg_C+0.418)-0.026*sin(3*0.331*Tavg_C+0.418))*
                                     -1.75+1), NA))

ggplot(fresh_snow, aes(x=Tavg_C))+
  geom_point(aes(y=HP_dens), color = "black")+
  geom_point(aes(y=DL_dens), color = "red")+
  geom_point(aes(y=LaCh_dens), color = "blue")+
  geom_point(aes(y=PS_dens), color = "green4")+
  theme_bw()+
  labs(x="Average Temperature (°C)", y="Fresh Snow Density (kg/m^3)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))
             
ggplot(fresh_snow%>%filter(!SY == "SY2005" & hour == 12), aes(x=HP_dens, y=alb_unfilt))+
  geom_point(aes(shape = site, color = DOSY))+
  scale_color_gradient2(low = "gray10", mid = "snow3", high = "gray10", midpoint = 201)+
  facet_wrap(~SY)+
  theme_bw()+
  labs(x="Fresh Snow Density (kg/m^3)", y = "Unfiltered Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  ylim(c(0,1))

ggplot(fresh_snow%>%filter(!SY == "SY2005" & hour == 12), aes(y=alb_unfilt))+
  geom_point(aes(x= DL_dens, shape = site), color = "red")+
  geom_point(aes(x= LaCh_dens, shape = site), color = "blue")+
  geom_point(aes(x= PS_dens, shape = site), color = "green4")+
  geom_point(aes(x= HP_dens, shape = site), color = "black")+
  facet_wrap(~SY)+
  theme_bw()+
  labs(x="Fresh Snow Density (kg/m^3)", y = "Unfiltered Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  ylim(c(0,1))

ggplot(fresh_snow%>%filter(!SY == "SY2005" & hour == 12), aes(y=alb_unfilt))+
  geom_point(aes(x= DL_dens, shape = site), color = "red")+
  geom_point(aes(x= LaCh_dens, shape = site), color = "blue")+
  geom_point(aes(x= PS_dens, shape = site), color = "green4")+
  geom_point(aes(x= HP_dens, shape = site), color = "black")+
  theme_bw()+
  labs(x="Fresh Snow Density (kg/m^3)", y = "Unfiltered Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  ylim(c(0,1))


```

### Depth And Density

```{r}

fresh_snow_2 <- fresh_snow%>%
  mutate(depth_diff = depth_m - lag(depth_m))%>%
  mutate(HP_SWE_mm = HP_dens * depth_diff)%>%
  mutate(HP_SWE_mm = ifelse(is.na(HP_SWE_mm), 0, HP_SWE_mm))

ggplot(fresh_snow_2, aes(x=depth_diff))+
  geom_point(aes(y= DL_dens, shape = site), color = "red")+
  geom_point(aes(y= LaCh_dens, shape = site), color = "blue")+
  geom_point(aes(y= PS_dens, shape = site), color = "green4")+
  geom_point(aes(y= HP_dens, shape = site), color = "black")+
  theme_bw()+
  labs(x="Depth Difference (m)", y = "Fresh Snow Density (kg/m^3)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  xlim(0,1)
  
ggplot(fresh_snow_2%>%filter(hour==12 & depth_diff < 0.2 & depth_diff >0), aes(x=HP_SWE_mm))+
  geom_point(aes(y=alb_unfilt, shape=site, color = depth_diff))+
  xlim(0,12)+
  ylim(0,1)+
  theme_bw()

ggplot(fresh_snow_2%>%filter(hour==12 & site == "SASP" & HP_SWE_mm <60), aes(x=datetime))+
  geom_line(aes(y=alb_unfilt))+
  geom_col(aes(y=HP_SWE_mm/12))+
  facet_wrap(~SY, scales = "free_x")+
  theme_bw()+
  scale_y_continuous(name = "Unfiltered Albedo", limits = c(0,1),
                     sec.axis = sec_axis(~.*12, name = "Fresh Snow SWE (mm)"))


```

### SWE Calculations
```{r}
SWE_yrly <- fresh_snow_2%>%
  filter(HP_SWE_mm <25)%>%
  group_by(SY)%>%
  summarize(sum(HP_SWE_mm))
  
```

### Fresh Snow Albedo
```{r}
fresh_snow_3 <- fresh_snow_2 %>%
  filter(alb_unfilt < 0.99 & alb_unfilt > 0.1)%>%
  mutate(alb_diff = alb_unfilt - lag(alb_unfilt))

ggplot(fresh_snow_3%>%filter(depth_diff >0 & hour == 12), aes(x=Tavg_C, y=alb_diff))+
  geom_point(aes(color = DOSY))+
  scale_color_gradient2(low = "gray10", mid = "snow3", high = "gray10", midpoint = 201)+
  theme_bw()

fresh_snow_events_SASP <- fresh_snow_3%>%
  #filter(site == "SASP")%>%
  filter(depth_diff > 0 & alb_diff > 0)%>%
  mutate(alb_tminus1 = alb_unfilt - alb_diff,
         temp_tminus1 = lag(Tavg_C))%>%
  mutate(temp_cat = ifelse(temp_tminus1 > 3, ">3°C", 
                           ifelse(temp_tminus1 < 3 & temp_tminus1 > -3, "-3°C to 3°C",
                                  ifelse(temp_tminus1 < -3 & temp_tminus1 > -10, "-10°C to -3°C", "<-10°C"))))%>%
  filter(!is.na(temp_cat))

fresh_snow_events_SASP$temp_cat <- factor(fresh_snow_events_SASP$temp_cat, levels = c(">3°C", "-3°C to 3°C", "-10°C to -3°C", "<-10°C" ))

ggplot(fresh_snow_events_SASP, aes(x=DOSY, y=alb_tminus1))+
  geom_point(aes(color = alb_diff))+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  facet_wrap(~SY)+
  labs(x="DOSY", y="Albedo:(t-1)")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())
  
ggplot(fresh_snow_events_SASP, aes(x=DOSY, y=alb_unfilt))+
  geom_point(aes(color = alb_diff))+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  facet_wrap(~SY)+
  labs(x="DOSY", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())
```


### Numerical Analysis

```{r}

fresh_snow_SASP <- fresh_snow_events_SASP%>%
  mutate(depth_perc = ifelse(depth_m >0, depth_diff/depth_m, NA),
         depth_perc = depth_perc*100)%>%
  filter(depth_diff < 0.1 | alb_unfilt > 0.3)%>%
  filter(depth_diff < 0.6)%>%
  mutate(temp_change = Tavg_C - temp_tminus1)

ggplot(fresh_snow_SASP, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = depth_diff))+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  labs(x="Depth (m)", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  facet_wrap(~temp_cat)

ggplot(fresh_snow_SASP%>%filter(depth_diff < 0.05), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color=depth_diff))+
  theme_bw()+
  scale_color_gradient(low = "blue", high = "red")+
  ylim(c(0,1))+
  facet_wrap(~temp_cat)+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Depth (m)", y="Albedo")

```


```{r}

ggplot(fresh_snow_SASP, aes(x=depth_perc, y=alb_unfilt))+
  geom_point(aes(shape = temp_cat, color = depth_diff))+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  facet_wrap(~SY)+
  labs(x="%∆Depth", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())

ggplot(fresh_snow_SASP,aes(x=alb_tminus1, y=alb_unfilt))+
  geom_point(aes(shape = temp_cat, color = depth_perc))+
  scale_color_gradient(low = "blue", high = "red")+
  geom_abline()+
  theme_bw()+
  ylim(c(0,1))+
  xlim(c(0,1))+
  facet_wrap(~SY)+
  labs(x="Albedo (t-1)", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())
  

ggplot(fresh_snow_SASP%>%filter(depth_diff <0.3), aes(x=temp_tminus1, y=alb_unfilt))+
  geom_point(aes(shape = temp_cat, color = depth_diff))+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  labs(x="Temperature(°C): (t-1)", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())



```

Clustering Attempt
```{r}
names(fresh_snow_SASP)
cluster_date <- fresh_snow_SASP %>%
  filter(hour %in% c(10,11,12,13,14))%>%
  filter(depth_diff > 0.01)%>%
  select(alb_unfilt, temp_tminus1)
head(cluster_date)
cls <- kmeans(x=cluster_date, centers = 3)
cluster_date$cluster <- as.character(cls$cluster)
head(cluster_date)
head(cls$centers)

stats_temp<-cluster_date%>%
  group_by(cluster)%>%
  summarize(min = min(temp_tminus1),
            max = max(temp_tminus1))
stats_temp
  
ggplot()+
  geom_point(data = cluster_date, 
             mapping = aes(x=temp_tminus1, 
                          y=alb_unfilt, color = cluster, shape = cluster))+
  geom_point(mapping = aes_string(x=cls$centers[,"temp_tminus1"],
                                  y=cls$centers[,"alb_unfilt"]),color = "snow", size=4)+
  geom_text(mapping = aes_string(x=cls$centers[,"temp_tminus1"],
                                 y=cls$centers[,"alb_unfilt"],
                                 label = 1:3), color = "black", size = 6, family = "Times New Roman")+
  theme_bw()+
  ylim(c(0,1))+
  labs(x="Temperature°C (t-1)", y="Albedo")+  
  theme(text = element_text(size = 17.5, family = "Times New Roman"), 
        legend.title = element_blank())


```

### Cluster DataFrames

```{r}
group_1 <- cluster_date%>%
  filter(cluster == 1)

hist(group_4$alb_unfilt)

summary(group_1)
group_2 <- cluster_date%>%
  filter(cluster == 2)
summary(group_2)
group_3 <- cluster_date%>%
  filter(cluster == 3)
summary(group_3)
group_4 <- cluster_date%>%
  filter(cluster == 4)
summary(group_4)


unique(fresh_snow_SASP$temp_cat)


ggplot(fresh_snow_SASP%>%filter(temp_cat == ">3°C"), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = depth_diff))+
  ylim(c(0,1))
ggplot(fresh_snow_SASP%>%filter(temp_cat == "-3°C to 3°C"), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = depth_diff))+
  ylim(c(0,1))
ggplot(fresh_snow_SASP%>%filter(temp_cat == "-10°C to -3°C"), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = depth_diff))+
  ylim(c(0,1))
ggplot(fresh_snow_SASP%>%filter(temp_cat == "<-10°C"), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = depth_diff))+
  ylim(c(0,1))

ggplot(fresh_snow_SASP%>%filter(depth_diff < 0.1)%>%rename(Albedo = alb_unfilt, Site = site, Difference = depth_diff), aes(x=depth_m, y=Albedo))+
  geom_point(aes(color = Difference, shape = Site), size =2)+
  facet_wrap(~temp_cat)+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()
  scale_y_continuous(breaks = c(0,0.01,0.02, 0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.1))+
  ylab("Albedo")+
  xlab("Depth (m)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))
  
  
# ggplot(fresh_snow_SASP%>%filter(depth_diff < 0.4 & temp_cat == "<-10°C" & !is.na(depth_diff))%>%rename(Albedo = alb_unfilt, Site = site, Difference = depth_diff), aes(x=depth_m, y=Albedo))+
#   geom_point(aes(color = alb_tminus1, shape = Site), size =2)+
#   facet_wrap(~Difference)+
#   scale_color_gradient(low = "blue", high = "red")+
#   theme_bw()



```


### Depth difference Bins

```{r}

function(tempcat){
    
  df <- fresh_snow_SASP%>%
    filter(temp_cat == tempcat)%>%
    mutate(depth_diff = as.numeric(depth_diff))%>%
    mutate(depth_diff = round(depth_diff, digits = 2))%>%
    mutate(depth_diff_bin = ifelse(depth_diff >= 0.04, ">0.04m", 
                            ifelse(depth_diff == 0.03, "0.03m", 
                            ifelse(depth_diff == 0.02, "0.02m", 
                            ifelse(depth_diff == 0.01, "0.01m", NA)))))%>%
    rename(PreAlbedo = alb_tminus1)
  
  df$depth_diff_bin <- factor(df$depth_diff_bin, levels = c("0.01m", "0.02m", "0.03m", ">0.04m"))
                                 
  plot <- ggplot(df, aes(x=depth_m, y=alb_unfilt))+
    geom_point(aes(color = PreAlbedo))+
    facet_wrap(~depth_diff_bin)+
    scale_color_gradient(low = "blue", high = "red")+
    theme_bw()+
    ylim(c(0,1))+
    labs(title = {{tempcat}})+
    xlab("Depth (m)")+
    ylab("Albedo")
  
    
return(plot)  
}

unique(fresh_snow_SASP$temp_cat)

depth_diff_function(">3°C")
depth_diff_function("-3°C to 3°C")
depth_diff_function("-10°C to -3°C")
depth_diff_function("<-10°C")

```


### Both Bins
```{r}

fresh_snow_allbins <- fresh_snow_SASP%>%
    mutate(depth_diff = as.numeric(depth_diff))%>%
    mutate(depth_diff = round(depth_diff, digits = 2))%>%
    mutate(depth_diff_bin = ifelse(depth_diff >= 0.04, ">0.04m", 
                            ifelse(depth_diff == 0.03, "0.03m", 
                            ifelse(depth_diff == 0.02, "0.02m", 
                            ifelse(depth_diff == 0.01, "0.01m", NA)))))%>%
    rename(PreAlbedo = alb_tminus1)

fresh_snow_allbins$depth_diff_bin <- factor(fresh_snow_allbins$depth_diff_bin, levels = c(">0.04m", "0.03m", "0.02m", "0.01m"))

fresh_snow_allbins$temp_cat <- factor(fresh_snow_allbins$temp_cat, levels = c("<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" ))

ggplot(fresh_snow_allbins%>%filter(hour%in%c(10,11,12,13,14)), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site))+
  theme_bw()+
  facet_grid(depth_diff_bin~temp_cat)+
  scale_color_gradient(low = "black", high = "snow2")+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Broadband Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())



```

### Larger Depth Bins
```{r}
fresh_snow_allbins_2 <- fresh_snow_SASP%>%
    mutate(depth_diff = as.numeric(depth_diff))%>%
    mutate(depth_diff = round(depth_diff, digits = 2))%>%
    mutate(depth_diff_bin = ifelse(depth_diff >= 0.06, ">=0.06m", 
                            ifelse(depth_diff >= 0.04 & depth_diff < 0.06, "0.04m - <0.06m", 
                            ifelse(depth_diff >= 0.02 & depth_diff < 0.04, "0.02m - <0.04m", 
                            ifelse(depth_diff < 0.02, "<0.02m", 0)))))%>%
    rename(PreAlbedo = alb_tminus1)

fresh_snow_allbins_2$depth_diff_bin <- factor(fresh_snow_allbins_2$depth_diff_bin, levels = c(">=0.06m", "0.04m - <0.06m", "0.02m - <0.04m", "<0.02m"))

fresh_snow_allbins_2$temp_cat <- factor(fresh_snow_allbins$temp_cat, levels = c("<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" ))

ggplot(fresh_snow_allbins_2, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site))+
  theme_bw()+
  facet_grid(depth_diff_bin~temp_cat)+
  scale_color_gradient(low = "black", high = "snow2")+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Broadband Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())
```

### Density with all Bins
```{r}

fresh_snow_dens <- fresh_snow_allbins%>%
  merge(RMP_density, by = "date")

dens_xts <- fresh_snow_dens%>%
  select(2,16,40,41,42)%>%
  xts(., order.by = .$datetime)
dygraph(dens_xts)

names(end_density)
end_density <- fresh_snow_dens%>%
  filter(DOSY > 250 & depth_m > 0, density < 500)%>%
  select(2, 16, 41, 42)

ggplot(end_density, aes(x=datetime))+
  geom_line(aes(y=depth_m), color = "black")+
  geom_line(aes(y=swe_mm/100), color = "blue")+
  facet_wrap(~year(datetime),scales = "free_x")

ggplot(fresh_snow_dens%>%filter(density >0 & hour %in% c(10,11,12,13,14)), aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = density, shape = site))+
  theme_bw()+
  facet_grid(depth_diff_bin~temp_cat)+
  scale_color_gradient(low = "snow2", high = "black")+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Fresh Snow Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())
```

### Bin Stats
```{r}
stats_depth_temp <- fresh_snow_dens%>%
  group_by(temp_cat, depth_diff_bin)%>%
  summarize(min = min(alb_unfilt),
            mean = mean(alb_unfilt),
            max = max(alb_unfilt))

stats_depth_temp

```

### 16 bins to 4
# Coldest
```{r}
# "<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" 
# ">0.04m", "0.03m", "0.02m", "0.01m"

cold_deep <- fresh_snow_dens%>%
  filter(temp_cat %in% c("<-10°C", "-10°C to -3°C"))%>%
  filter(depth_diff_bin %in% c(">0.04m", "0.03m"))%>%
  filter(hour %in% c(10,11,12,13,14))

mean(cold_deep$alb_unfilt)

ggplot(cold_deep, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site), size =2)+
  theme_bw()+
  scale_color_gradient(low = "black", high = "white", limits = c(0.5,1))+
  ylim(c(0.5,1))+
  labs(x= "Depth (m)", y="Fresh Snow Albedo", color = "Albedo (t-1)", shape = "Site", title = "Cold (<-3°C) & Major Accumulation (>0.03 m) ")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  geom_hline(yintercept = 0.88)

ggscatter(cold_deep,
          x = "depth_m", 
          y = "alb_unfilt", add = "reg.line")+
  stat_cor(label.x = 1, label.y = 0.6) +
  stat_regline_equation(label.x = 1, label.y = 0.55) + 
  labs(x='Depth_m (m)', y= 'Fresh Snow Albedo')+
  theme_linedraw()+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))


# ggplot(cold_deep, aes(x=depth_m, y=alb_unfilt))+
#   geom_point(aes(color = density, shape = site))+
#   theme_bw()+
#   scale_color_gradient(low = "white", high = "black", limits = c(100,500))+
#   ylim(c(0.5,1))+
#   labs(x= "Depth (m)", y="Fresh Snow Albedo", color = "Density", shape = "Site")+
#   theme(text = element_text(size = 17.5, family = "Times New Roman"))
# ggplot(cold_deep, aes(x=PreAlbedo, y=alb_unfilt))+
#   geom_point(aes(color = depth_m, shape = site), size =2)+
#   theme_bw()+
#   scale_color_gradient(low = "black", high = "white", limits = c(0,3))+
#   ylim(c(0.5,1))+
#   labs(x= "Albedo (t-1)", y="Fresh Snow Albedo", color = "Depth (m)", shape = "Site")+
#   theme(text = element_text(size = 17.5, family = "Times New Roman"))


```

```{r}
# "<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" 
# ">0.04m", "0.03m", "0.02m", "0.01m"

cold_shallow <- fresh_snow_dens%>%
  filter(Tavg_C <= -3)%>%
  filter(depth_diff_bin %in% c("0.02m", "0.01m"))%>%
  filter(hour %in% c(10,11,12,13,14))

mean(cold_shallow$alb_unfilt)

ggplot(cold_shallow, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site), size =2)+
  theme_bw()+
  scale_color_gradient(low = "black", high = "white", limits = c(0,1))+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Fresh Snow Albedo", color = "Albedo (t-1)", shape = "Site", title = "Cold (<-3°C) & Minor Accumulation (<=0.03 m) ")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  geom_hline(yintercept = 0.86)

ggscatter(cold_shallow,
          x = "depth_m", 
          y = "alb_unfilt", add = "reg.line")+
  stat_cor(label.x = 1.75, label.y = 0.5) +
  stat_regline_equation(label.x = 1.75, label.y = 0.45) + 
  labs(x='Depth_m (m)', y= 'Fresh Snow Albedo')+
  theme_linedraw()+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))
```

# Warmest
```{r}
# "<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" 
# ">0.04m", "0.03m", "0.02m", "0.01m"

warm_deep <- fresh_snow_dens%>%
  filter(temp_cat %in% c("-3°C to 3°C",">3°C"))%>%
  filter(depth_diff_bin %in% c(">0.04m", "0.03m"))%>%
  filter(hour %in% c(10,11,12,13,14))

mean(warm_deep$alb_unfilt)

ggplot(warm_deep, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site), size =2)+
  theme_bw()+
  scale_color_gradient(low = "black", high = "white", limits = c(0,1))+
  ylim(c(0.2,1))+
  labs(x= "Depth (m)", y="Fresh Snow Albedo", color = "Albedo (t-1)", shape = "Site",title = "Warm (>-3°C) & Major Accumulation (>0.03 m)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  geom_hline(yintercept = 0.80)

ggscatter(warm_deep,
          x = "depth_m", 
          y = "alb_unfilt", add = "reg.line")+
  stat_cor(label.x = 1.5, label.y = 0.5) +
  stat_regline_equation(label.x = 1.5, label.y = 0.45) + 
  labs(x='Depth_m (m)', y= 'Fresh Snow Albedo')+
  theme_linedraw()+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))

```

```{r}
# "<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" 
# ">0.04m", "0.03m", "0.02m", "0.01m"

warm_shallow <- fresh_snow_dens%>%
  filter(temp_cat %in% c("-3°C to 3°C",">3°C"))%>%
  filter(depth_diff_bin %in% c("0.02m", "0.01m"))%>%
  filter(hour %in% c(10,11,12,13,14))

mean(warm_shallow$alb_unfilt)

ggplot(warm_shallow, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = PreAlbedo, shape = site), size =2)+
  theme_bw()+
  scale_color_gradient(low = "black", high = "white", limits = c(0,1))+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Fresh Snow Albedo", color = "Albedo (t-1)", shape = "Site",title = "Warm (>-3°C) & Minor Accumulation (<=0.03 m)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  geom_hline(yintercept = 0.74)

ggscatter(warm_shallow,
          x = "depth_m", 
          y = "alb_unfilt", add = "reg.line")+
  stat_cor(label.x = 1.5, label.y = 0.3) +
  stat_regline_equation(label.x = 1.5, label.y = 0.25) + 
  labs(x='Depth_m (m)', y= 'Fresh Snow Albedo')+
  theme_linedraw()+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))
```

### Ground Albedo (random)
```{r}

ground_alb <- sasp_sbsp_long%>%
  filter(depth_m == 0)%>%
  filter(alb_unfilt > 0.1 & alb_unfilt < 0.97)### the rest of the code describes avgs. per site
  filter(alb_unfilt < 0.325)%>%
  group_by(site)%>%
  summarise(mean = mean(alb_unfilt))

ground_alb
##SASP = 0.189
##SBSP = 0.207
  

ggplot(ground_alb, aes(x=alb_unfilt))+
  geom_histogram(aes(color = site, fill = site),
                 position = "identity", bins = 25, alpha = 0.3)+
  scale_color_manual(values = c("#00AFBB", "#E7B800"))+
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))+
  theme_bw()


```


### Wind (random)
```{r}
# wind <- fresh_snow%>%
#   filter(site == "SASP")
#   #filter(month(datetime) %in% c(12,1,2,3,4))
#   group_by(month(datetime))%>%
#   summarise(mean = mean(Uavg_MS, na.rm = T))%>%
#   rename(month = 1)
# 
# summary(wind)
# wind
# 
# ggplot(wind, aes(x=month, y= mean))+
#   geom_point()

```

### 3 Hour Timescale

```{r}

three_hour <- sasp_sbsp_long%>%
  filter(hour %in% c(9,12,15))%>%
  filter(!SY == "SY2005")%>%
  mutate(depth_diff = depth_m-lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0, depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt),
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff))%>%
  filter(alb_diff > 0 & depth_diff > 0)


ggplot(three_hour, aes(x=Tavg_C, y=alb_unfilt))+
  geom_point(aes(color = depth_m))
hist(three_hour$depth_diff)

three_hour_binned <- three_hour%>%
   mutate(depth_diff = as.numeric(depth_diff))%>%
   mutate(depth_diff = round(depth_diff, digits = 2))%>%
   mutate(depth_diff_bin = ifelse(depth_diff >= 0.06, ">=0.06m", 
                            ifelse(depth_diff >= 0.04 & depth_diff < 0.06, "0.04m - <0.06m", 
                            ifelse(depth_diff >= 0.02 & depth_diff < 0.04, "0.02m - <0.04m", 
                            ifelse(depth_diff < 0.02, "<0.02m", 0)))))%>%
  mutate(alb_tminus1 = alb_unfilt - alb_diff,
         temp_tminus1 = lag(Tavg_C))%>%
  mutate(temp_cat = ifelse(temp_tminus1 > 3, ">3°C", 
                           ifelse(temp_tminus1 < 3 & temp_tminus1 > -3, "-3°C to 3°C",
                                  ifelse(temp_tminus1 < -3 & temp_tminus1 > -10, "-10°C to -3°C", "<-10°C"))))%>%
  filter(!is.na(temp_cat))
  
three_hour_binned$depth_diff_bin <- factor(three_hour_binned$depth_diff_bin, levels = c(">=0.06m", "0.04m - <0.06m", "0.02m - <0.04m", "<0.02m"))

three_hour_binned$temp_cat <- factor(three_hour_binned$temp_cat, levels = c("<-10°C", "-10°C to -3°C", "-3°C to 3°C",">3°C" ))

ggplot(three_hour_binned, aes(x=depth_m, y=alb_unfilt))+
  geom_point(aes(color = alb_tminus1, shape = site))+
  theme_bw()+
  facet_grid(depth_diff_bin~temp_cat)+
  scale_color_gradient(low = "black", high = "snow2")+
  ylim(c(0,1))+
  labs(x= "Depth (m)", y="Broadband Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.title = element_blank())

```

### Linear Model Attempt

```{r}
lm_cold_deep <- lm(data = cold_deep, alb_unfilt ~ depth_m + depth_diff)
summary(lm_cold_deep)
cor(cold_deep$depth_m, cold_deep$density, method = "kendall")
confint(lm_cold_deep)
plot(lm_cold_deep)

lm_cold_shallow <- lm(data = cold_shallow, alb_unfilt ~ depth_m + depth_diff)
summary(lm_cold_shallow)
confint(lm_cold_shallow)
plot(lm_cold_shallow)

lm_warm_deep <- lm(data = warm_deep, alb_unfilt ~ depth_m + depth_diff)
summary(lm_warm_deep)
confint(lm_warm_deep)

lm_warm_shallow <- lm(data = warm_shallow, alb_unfilt ~ depth_m + depth_diff)
summary(lm_warm_shallow)
confint(lm_warm_shallow)

```


### Cold
```{r}

cold_fresh <- fresh_snow_dens%>%
  filter(Tavg_C < -3)%>%
  filter(hour %in% c(10,11,12,13,14))

lm_cold <- lm(data = cold_fresh, alb_unfilt ~ depth_diff + depth_m)
lm_cold_log <- lm(data = cold_fresh, alb_unfilt ~ depth_diff + log(depth_m))
summary(lm_cold)
summary(lm_cold_log)
plot(lm_cold)

ggplot(cold_fresh%>%filter(depth_diff>0.01), aes(x=depth_diff, y=alb_unfilt, color = depth_m))+
  geom_point()+
  stat_smooth(method = "lm", formula = y~log(x))


ggplot(cold_fresh%>%filter(depth_diff <= 0.03 & depth_diff > 0.01), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_continuous(low = "blue", high = "red")+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(cold_fresh%>%filter(depth_diff > 0.03 & depth_diff <0.2), aes(x=depth_m, y=alb_unfilt, color = PreAlbedo))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_gradient(low = "red", high = "black")+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "PreAlbedo", shape = "Site")

ggplot(cold_fresh%>%filter(depth_diff <0.2&depth_diff>0.01), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_gradient2(low = "blue", mid = "red", high = "black", midpoint = 0.1)+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")


# ggplot(cold_deep, aes(x=depth_diff, y=alb_unfilt, color = depth_m))+
#   geom_point()+
#   stat_smooth(method = "lm", formula = y~log(x))
# ggplot(cold_shallow, aes(x=depth_diff, y=alb_unfilt, color = depth_m))+
#   geom_point()+
#   stat_smooth(method = "lm", formula = y~log(x))


```

### Cold Depth Difference
```{r}
cold_deep2 <- cold_fresh%>%
  filter(depth_diff > 0.03)
lm_cold_deep_2 <- lm(data = cold_deep2, alb_unfilt ~ log(depth_m))
summary(lm_cold_deep_2)
coef(lm_cold_deep_2)
confint(lm_cold_deep_2)
summary(lm_cold_deep_2)$adj.r.squared
#y =0.897 + 0.004*log(depth_m)
#y = 0.892 to 0.90
#x = -0.003 - 0.01

cold_shallow2 <- cold_fresh%>%
  filter(depth_diff <= 0.03)
lm_cold_shallow_2 <- lm(data = cold_shallow2, alb_unfilt ~ log(depth_m))
summary(lm_cold_shallow_2)
coef(lm_cold_shallow_2)
confint(lm_cold_shallow_2)
summary(lm_cold_shallow_2)$r.squared
#y = 0.87 + 0.02*log(depth_m)
#y = 0.878-874
#x = 0.0177 - 0.257

lm_cold_fresh <- lm(data = cold_fresh, alb_unfilt ~ log(depth_m))
summary(lm_cold_fresh)
coef(lm_cold_fresh)
confint(lm_cold_fresh)
summary(lm_cold_fresh)$r.squared
#y = 0.87 + 0.02*log(depth_m)
#y = 0.871 to 0.877
#x = 0.0166 to 0.024
```

### Warm

```{r}

warm_fresh <- fresh_snow_dens%>%
  filter(Tavg_C > -3)

ggplot(warm_fresh, aes(x=depth_diff, y=alb_unfilt, color = depth_m))+
  geom_point()+
  stat_smooth(method = "lm", formula = y~log(x))
ggplot(warm_fresh, aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point()+
  stat_smooth(method = "lm", formula = y~log(x))

ggplot(warm_fresh%>%filter(depth_diff <= 0.03), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_continuous(low = "blue", high = "red")+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(warm_fresh%>%filter(depth_diff > 0.03 & depth_diff <0.2), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_gradient(low = "red", high = "black")+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(warm_fresh%>%filter(depth_diff <0.2), aes(x=depth_m, y=alb_unfilt, color = density))+
  geom_point(aes(shape = site), size = 1)+
  scale_color_gradient2(low = "blue", mid = "red", high = "black", midpoint = 200)+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  ylim(c(0,1))+
  theme_bw()+
  labs(x="Depth (m)", y= "Fresh Snow Albedo", color = "Density (kg/m^3)", shape = "Site")

# ggplot(warm_fresh%>%filter(depth_diff <0.2 & density >0), aes(x=density, y=alb_unfilt, color = depth_m))+
#   geom_point(aes(shape = site), size = 1)+
#   scale_color_gradient2(low = "blue", mid = "red", high = "black", midpoint = 1)+
#   stat_smooth(method = "lm", formula = y~log(x), color = "black")+
#   ylim(c(0,1))+
#   theme_bw()+
#   labs(x="Density (kg/m^3))", y= "Fresh Snow Albedo", color = "Depth (m)", shape = "Site")

```

### Warm Depth Difference

```{r}

warm_deep_2 <- warm_fresh%>%
    filter(depth_diff > 0.03)
lm_warm_deep2 <- lm(data = warm_deep_2, alb_unfilt ~ log(depth_m))
summary(lm_warm_deep2)
coef(lm_warm_deep2)
confint(lm_warm_deep2)
summary(lm_warm_deep2)$r.squared
# y = 0.8549 + 0.09*log(depth_m)
# y = 0.805 to 0.904
# x = 0.057 to 0.123


warm_shallow_2 <- warm_fresh%>%
    filter(depth_diff <= 0.03)
lm_warm_shallow2 <- lm(data = warm_shallow_2, alb_unfilt ~ log(depth_m))
summary(lm_warm_shallow2)
coef(lm_warm_shallow2)
confint(lm_warm_shallow2)
summary(lm_warm_shallow2)$r.squared
# y = 0.77 + 0.07*log(depth_m)
# y = 0.763 to 0.781
# x = 0.065 to 0.0767


lm_warm <- lm(data = warm_fresh, alb_unfilt ~ log(depth_m))
summary(lm_warm)
coef(lm_warm)
confint(lm_warm)
summary(lm_warm)$r.squared
# y = 0.776 + 0.07*log(depth_m)
# y = 0.767 to 0.785
# x = 0.066 to 0.0772

```


### Three Hour LM
```{r}
ggplot(three_hour%>%filter(Tavg_C > -3 & depth_diff < 0.04 & alb_unfilt < 0.98), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site))+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  scale_color_gradient(low = "blue", high = "red")+
  theme_bw()+
  ylim(c(0,1))+
  labs(x="Depth (m)", y = "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

three_shallow <- three_hour%>%
  filter(depth_diff < 0.04 & Tavg_C > -3)
three_lm_shallow <- lm(data =three_shallow, alb_unfilt ~ log(depth_m))
summary(three_lm_shallow)
confint(three_lm_shallow)
coef(three_lm_shallow)
summary(three_lm_shallow)$r.squared

ggplot(three_hour%>%filter(Tavg_C > -3 & depth_diff >= 0.04 & alb_unfilt < 0.98), aes(x=depth_m, y=alb_unfilt, color = depth_diff))+
  geom_point(aes(shape = site))+
  stat_smooth(method = "lm", formula = y~log(x), color = "black")+
  scale_color_gradient(low = "red", high = "black")+
  theme_bw()+
  ylim(c(0,1))+
  labs(x="Depth (m)", y = "Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

three_deep <- three_hour%>%
  filter(depth_diff <= 0.04 & Tavg_C > -3)
three_lm_deep <- lm(data = three_deep, alb_unfilt ~ log(depth_m))
summary(three_lm_deep)
confint(three_lm_deep)
coef(three_lm_deep)
summary(three_lm_deep)$r.squared
  



```


### Depth Stats

```{r}
depth_stats <- sasp_sbsp_long%>%
  group_by(SY, site)%>%
  filter(!is.na(depth_m))%>%
  summarize(max = max(depth_m))
dust_stats <- sasp_sbsp_long%>%
  group_by(SY)%>%
  filter(!is.na(dust_event))%>%
  summarize(max = max(dust_event))

names(sasp_sbsp_long)

sasp_xts <- sasp_sbsp_long%>%
  filter(site == "SASP")%>%
  filter(!SY == "SY2005")%>%
  select(1, 16)%>%
  filter(!is.na(datetime))%>%
  filter(depth_m < 4)%>%
  xts(., order.by = .$datetime)
dygraph(sasp_xts)

sbsp_xts <- sasp_sbsp_long%>%
  filter(site == "SBSP")%>%
  filter(!SY == "SY2005")%>%
  select(1, 16)%>%
  filter(!is.na(datetime))%>%
  filter(depth_m < 4)%>%
  xts(., order.by = .$datetime)
dygraph(sbsp_xts)

rmp_xts <- fresh_snow_dens%>%
  filter(!SY == "SY2005")%>%
  select(1,40,41)%>%
  filter(!is.na(is.numeric(.)))
  xts(., order.by = .$date)
dygraph(rmp_xts)

```


####***Starting New

```{r}
frsh_alb <- fresh_snow_dens%>%
  filter(depth_diff > 0.01 & depth_diff < 0.3)
ggplot(frsh_alb, aes(x=depth_diff, y=alb_diff))+
  geom_point(aes(color = PreAlbedo))

onestorm <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & alb_unfilt < 0.98)%>%
  filter(site == "SBSP")%>%
  select(datetime, depth_m, alb_unfilt)%>%
  xts(., order.by = .$datetime)
dygraph(onestorm)
```


Apr 9, 2008
```{r}
sy2008Apr9 <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & !is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(date == "2008-04-09")%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))

ggplot(sy2008Apr9%>%filter(depth_diff > -0.9), aes(x=datetime))+
  geom_col(aes(y=depth_diff*20, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_line(aes(y=alb_unfilt, color = site), size = 1)+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "Albedo",
                     sec.axis = sec_axis(~./20, name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.75,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title= "2008-Apr-09", subtitle = "SASP(~0.9meters), SBSP(~0.3meters)")
  
ggplot(sy2008Apr9%>%filter(depth_diff > -0.9), aes(x=datetime))+
  geom_col(aes(y=depth_diff, fill = site), position = "dodge", alpha = 1)+
  geom_area(aes(y=alb_diff, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "∆Albedo",
                     sec.axis = sec_axis(~., name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title= "2008-Apr-09", subtitle = "SASP(~2.35meters), SBSP(~1.55meters)")
```

Dec 7 2007
```{r}
sy2008Dec7 <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & !is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(date == "2007-12-07")%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))

ggplot(sy2008Dec7%>%filter(depth_diff > -0.3), aes(x=datetime))+
  geom_col(aes(y=depth_diff*10, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_line(aes(y=alb_unfilt, color = site), size = 1)+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "Albedo",
                     sec.axis = sec_axis(~./10, name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.75,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site", title= "2007-Dec-07", subtitle = "SASP(~0.9meters), SBSP(~0.3meters)")

ggplot(sy2008Dec7%>%filter(depth_diff > -0.3), aes(x=datetime))+
  geom_col(aes(y=depth_diff, fill = site), position = "dodge", alpha = 1)+
  geom_area(aes(y=alb_diff, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "∆Albedo",
                     sec.axis = sec_axis(~., name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title= "2007-Dec-07", subtitle = "SASP(~0.9meters), SBSP(~0.3meters)")

```


Jan 3 2008
```{r}
sy2008Jan3 <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & !is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(date == "2008-01-03")%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))

ggplot(sy2008Jan3%>%filter(depth_diff > -0.3), aes(x=datetime))+
  geom_col(aes(y=depth_diff*30, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_line(aes(y=alb_unfilt, color = site), size = 1)+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "Albedo",
                     sec.axis = sec_axis(~./30, name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.8,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site", title= "2008-Jan-03", subtitle = "SASP(~1.1meters), SBSP(~0.3meters)")

ggplot(sy2008Jan3%>%filter(depth_diff > -0.3), aes(x=datetime))+
  geom_col(aes(y=depth_diff, fill = site), position = "dodge", alpha = 1)+
  geom_area(aes(y=alb_diff, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "∆Albedo",
                     sec.axis = sec_axis(~., name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title= "2008-Jan-03", subtitle = "SASP(~1.1meters), SBSP(~0.3meters)")


```


Oct 21 2007

```{r}
sy2007Oct21 <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & !is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(date == "2007-10-21")%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))

ggplot(sy2007Oct21%>%filter(depth_diff > -0.15), aes(x=datetime))+
  geom_col(aes(y=depth_diff*30, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_line(aes(y=alb_unfilt, color = site), size = 1)+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "Albedo",
                     sec.axis = sec_axis(~./30, name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site", title= "2007-Oct-21", subtitle = "SASP(~0.35meters), SBSP(~0.25meters)")

ggplot(sy2007Oct21%>%filter(depth_diff > -0.15), aes(x=datetime))+
  geom_col(aes(y=depth_diff, fill = site), position = "dodge", alpha = 1)+
  geom_area(aes(y=alb_diff, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "∆Albedo",
                     sec.axis = sec_axis(~., name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title= "2007-Oct-21", subtitle = "SASP(~0.35meters), SBSP(~0.25meters)")
```

May 1 2008
```{r}

sy2008May1 <- sasp_sbsp_long%>%
  filter(SY == "SY2008" & !is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(date == "2008-05-01")%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))

ggplot(sy2008May1%>%filter(depth_diff > -0.15), aes(x=datetime))+
  geom_col(aes(y=depth_diff*30, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  geom_line(aes(y=alb_unfilt, color = site), size = 1)+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "Albedo",
                     sec.axis = sec_axis(~./30, name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site", title= "2008-May-01", subtitle = "SASP(~2.0meters), SBSP(~1.5meters)")

ggplot(sy2008May1%>%filter(depth_diff > -0.15 & alb_diff < 0.4), aes(x=datetime))+
  geom_col(aes(y=depth_diff, fill = site), position = "dodge", alpha = 1)+
  geom_area(aes(y=alb_diff, fill = site), position = "dodge", alpha = 0.4)+
  scale_fill_manual(values = c("red", "blue"))+
  scale_color_manual(values = c("red", "blue"))+
  theme_bw()+
  scale_y_continuous(name = "∆Albedo",
                     sec.axis = sec_axis(~., name = "∆Depth (m)"))+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.5,0.15))+
  labs(x="Datetime", color = "Site", fill = "Site",  title=  "2008-May-01", subtitle = "SASP(~2.0meters), SBSP(~1.5meters)")
```

### DepthDiff Attempt
```{r}

best_hours <- sasp_sbsp_long%>%
  group_by(site)%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         alb_diff = alb_unfilt - lag(alb_unfilt), 
         alb_diff = ifelse(is.na(alb_diff), 0, alb_diff),
         alb_tminus1 = alb_unfilt - alb_diff,
         temp_tminus1 = lag(Tavg_C),
         temp_tminus1 = ifelse(is.na(temp_tminus1), 0, temp_tminus1))%>%
  ungroup()%>%
  filter(hour %in% c(10,11,12,13,14))%>%
  filter(!is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  mutate(depth_diff = as.numeric(depth_diff),
         depth_diff = round(depth_diff, digits =2))%>%
  filter(depth_diff > -0.2 & depth_diff < 0.2)%>%
  filter(depth_diff > 0.01)%>%
  mutate(depth_bin = ifelse(depth_m < 0.2, "Shallow (<0.2m)",
                            ifelse(depth_m >= 0.2 & depth_m < 0.5, "Mid (0.2-0.5m)",
                                   "Deep (>0.5m)")))%>%
         #depth_bin = factor(depth_bin, levels = c("Shallow", "Mid", "Deep")))%>%
  mutate(temp_bin = ifelse(temp_tminus1 < -3, "Colder (<-3°C)", "Warmer (>-3°C)"))%>%
  mutate(next_filt = ifelse(DOSY > 30 & DOSY < 60 & depth_diff > 0.05 & alb_unfilt < 0.3 & depth_m > 0.1, NA, "OK"))%>%
  filter(!is.na(next_filt))%>%
  mutate(depth_diff_bin = ifelse(depth_diff >0.01 & depth_diff <= 0.03, "Light Accum (0.02-0.03m)", "Large Accum (>0.03m)"),
         depth_diff_bin = factor(depth_diff_bin, levels = c("Light Accum (0.02-0.03m)","Large Accum (>0.03m)")))

ggplot(best_hours, aes(x=depth_diff, y= alb_unfilt))+
  geom_point(aes(shape = site, color = temp_tminus1))+
  theme_bw()+
  ylim(c(0,1))+
  xlim(0,0.2)+
  scale_color_gradient2(low = "blue4", mid = "snow2", high = "red4", midpoint = -3)+
  facet_grid(depth_bin~temp_bin)+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="∆Depth (m)", y="Fresh Snow Albedo", color = "Temp°C (t-1)", shape = "Site")

ggplot(best_hours%>%filter(temp_tminus1 < -3), aes(x=temp_tminus1, y= alb_unfilt))+
  geom_point(aes(shape = site, color = depth_diff))+
  theme_bw()+
  ylim(c(0,1))+
  scale_color_gradient2(low = "blue4", mid = "snow4", high = "red4", midpoint = 0.05)+
  facet_grid(depth_bin~depth_diff_bin)+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Temp°C (t-1)", y="Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(best_hours%>%filter(temp_tminus1 > -3), aes(x=temp_tminus1, y= alb_unfilt))+
  geom_point(aes(shape = site))+
  theme_bw()+
  ylim(c(0,1))+
  scale_color_gradient2(low = "blue4", mid = "snow4", high = "red4", midpoint = 0.05)+
  facet_grid(depth_bin~depth_diff_bin)+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Temp°C (t-1)", y="Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")


ggplot(best_hours, aes(x=temp_tminus1, y= alb_unfilt))+
  geom_point(aes(shape = site, color = depth_diff))+
  theme_bw()+
  ylim(c(0,1))+
  scale_color_gradient2(low = "blue4", mid = "snow4", high = "red4", midpoint = 0.05)+
  facet_nested(depth_bin~depth_diff_bin +temp_bin, scales = "free_x")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Temperature °C (t-1)", y="Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(best_hours, aes(x=alb_tminus1, y= alb_unfilt))+
  geom_abline(alpha = 0.4)+
  geom_point(aes(shape = site, color = depth_diff))+
  theme_bw()+
  ylim(c(0,1))+
  xlim(c(0,1))+
  scale_color_gradient2(low = "blue4", mid = "snow4", high = "red4", midpoint = 0.05)+
  facet_nested(depth_bin~depth_diff_bin +temp_bin)+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Albedo (t-1)", y="Fresh Snow Albedo", color = "∆Depth (m)", shape = "Site")

ggplot(best_hours%>%filter(alb_vis < 1), aes(x=temp_tminus1, y= alb_unfilt))+
  geom_point(aes(shape = site, color = alb_filt))+
  theme_bw()+
  ylim(c(0,1))+
  scale_color_gradient2(low = "blue4", mid = "snow4", high = "red4", midpoint = 0.25)+
  facet_nested(depth_bin~depth_diff_bin +temp_bin, scales = "free_x")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  labs(x="Temperature °C (t-1)", y="Fresh Snow Albedo", color = "NIR/SWIR Albedo", shape = "Site")

oddvalues <- best_hours%>%
  filter(temp_tminus1 > 3 & alb_unfilt < 0.5)
## October 2005 and October 2008
oddvalues_xts <- sasp_sbsp_long%>%  
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff))%>%
  filter(!is.na(alb_unfilt) & alb_unfilt < 0.98)%>%
  filter(site == "SASP")%>%
  select(datetime, depth_m, alb_unfilt, depth_diff)%>%
  xts(., order.by = .$datetime)
dygraph(oddvalues_xts)


```

### Pattern Figure

```{r}

gen_plot <- sasp_sbsp_long%>%
  filter(hour == 12 & alb_unfilt < 0.98 & alb_unfilt > 0.15)%>%
  mutate(filt = ifelse(depth_m == 0 & DOSY > 120 & DOSY < 220, NA, "OK"))%>%
  filter(!is.na(filt))%>%
  filter(!is.na(depth_m))%>%
  group_by(DOSY, site)%>%
  summarize(mean_d = mean(depth_m),
            mean_alb = mean(alb_unfilt),
            max_d = max(depth_m),
            min_d = min(depth_m),
            max_alb = max(alb_unfilt),
            min_alb = min(alb_unfilt))%>%
  mutate(time = ifelse(DOSY < 90, "Early Events", 
                  ifelse(DOSY >= 90 & DOSY < 220, "Accumulation", "Melt")))%>%
  mutate(time = factor(time, levels = c("Early Events", "Accumulation", "Melt")))%>%
  filter(!DOSY == 344)

ggplot(gen_plot, aes(x=DOSY))+
  geom_errorbar(aes(ymin=min_alb, ymax =max_alb), color = "gray")+
  geom_line(aes(y=mean_alb), size = 1.5)+
  facet_grid(site~time, scales = "free_x")+
  theme_bw()+
  labs(y="Broadband Albedo")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))+
  ylim(c(0,1))

ggplot(gen_plot, aes(x=DOSY))+
  geom_errorbar(aes(ymin=min_d, ymax =max_d), color = "gray")+
  geom_line(aes(y=mean_d), size = 1.5, color = "steelblue3")+
  facet_grid(site~time, scales = "free_x")+
  theme_bw()+
  labs(y="Depth (m)")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"))

ggplot(gen_plot, aes(x=DOSY))+
  geom_errorbar(aes(ymin=min_d/4, ymax =max_d/4), color = "steelblue3", alpha = 0.5)+
  geom_line(aes(y=mean_d/4), size = 1.5, color = "steelblue3")+
  geom_errorbar(aes(ymin=min_alb, ymax =max_alb), color = "black", alpha = 0.5)+
  geom_line(aes(y=mean_alb), size = 1.5, color = "black")+
  facet_grid(site~time, scales = "free")+
  theme_bw()+
  theme(text = element_text(size = 17.5, family = "Times New Roman"),
        axis.text.y.right = element_text(colour="steelblue3"),
        axis.title.y.right = element_text(colour="steelblue3"))+
  scale_y_continuous(name = "Broadband Albedo",
                     sec.axis = sec_axis(~.*4, name = "Depth (m)"))
```

###Night Day Depth
```{r}

nightday <- sasp_sbsp_long%>%
  filter(!SY == "SY2005")%>%
  group_by(site)%>%
  mutate(depth_diff = depth_m - lag(depth_m),
         depth_diff = ifelse(is.na(depth_diff), 0 , depth_diff),
         time_bin = ifelse(is.na(alb_unfilt), "Night", "Day"))%>%
  mutate(depth_sign = ifelse(depth_diff < 0, "Negative", 
                             ifelse(depth_diff == 0, "No Change", "Positive")))%>%
  ungroup()%>%
  filter(depth_diff < 0.1 & depth_diff > -0.1)%>%
  filter(!depth_sign == "No Change")

ggplot(nightday, aes(x=depth_diff, color = time_bin, fill = time_bin))+
  geom_histogram(binwidth = 0.01, position = "dodge")+
  scale_color_manual(values = c("black", "black"))+
  scale_fill_manual(values = c("yellow", "gray30"))+
  theme_bw()+
  geom_vline(xintercept = 0)+
  labs(x="∆ Depth (m)", y = "Count", color = "Time", fill = "Time")+
  theme(text = element_text(size = 17.5, family = "Times New Roman"), legend.position = c(0.8, 0.75))+
  facet_wrap(~site, nrow = 2)

nightday_stats <- nightday%>%
  group_by(site, time_bin, depth_sign)%>%
  summarize(sum = sum(depth_diff))
nightday_stats

```

